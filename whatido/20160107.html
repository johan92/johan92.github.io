<html>

  <head>
    <title> Ivan Shevchuk </title>
    <meta charset ="utf-8">
    <link rel="stylesheet" type="text/css" href="../style.css">
  </head>

  <body>
    <div id = "page">
      <div id = "header">
        <h1>
          Ivan Shevchuk
        </h1>
      </div>

      <div id = "hmenu">
        <ul>
          <li> <a href="../index.html">Контакты (обо мне)</a></li>
          <li> <a href="../projects.html">Проекты</a></li>
          <li> <a href="../articles.html">Статьи/заметки</a></li>
          <li> <a href="../public.html">Выступления/конференции</a></li>
          <li> <a href="../en_index.html">English</a></li>
        </ul>
      </div>
      
      <div id = "content">

<h2>Чем я занимаюсь: синяя коробочка</h2>        
Этим постом я начинаю относительно постоянную рубрику (надеюсь)
под названием "Чем я занимаюсь?". В рамках её я буду
рассказывать и показывать чем я занимаюсь на работе (а может и не только это).

<br> 
<h3>Команда "Отгружать!"</h3>
Последние пару месяцев основные усилия нашей команды были направлены на то, чтобы доделать и отгрузить
новую аппаратную модификацию Bercut-ET, а так же принципиально новый дивайс Metrotek ETLN. 
В этом в принципе ничего интересного нет, т.к. с моей стороны участие в этом всём было минимальное, т.к. по FPGA задач особых не было.

<br>
<img src="https://habrastorage.org/files/8ac/af6/943/8acaf69433ee402a95b43cca48ff0014.jpg" width=500 height=250/>
<br>
<i>Вот так выглядит Metrotek ETLN.</i>

<br> <br>

Параллельно этому усилия были направлены на демонстрацию Metrotek ETNS - тоже нового
девайса, который стоит из двух частей: измерительная часть с FPGA и телефон с Андроидом.
<br>
<img src="https://hsto.org/files/095/5d4/304/0955d43049624a408c935a8305af8979.jpg" width=300 height=600/>
<br>
<i>А вот это Metrotek ETNS. <br>
  (Сорян за рендер, я был уверен, что в наших закромах в files лежит какая-то красивая реальная картинка, но её найти не смог.
А сейчас я не на работе.)</i>

<br> <br>

С одной стороны это звучит немного забавно и не очень адекватно,
с другой стороны может быть и выстрелить, если людей это не будет пугать. Посмотрим.
Инвесторам-партнерам вроде как демонстрация понравилась, так что, возможно, всё будет ок.

<br> <br>

Прошивки по FPGA по этим проектам уже было закончены, а ТЗ по новым фичам не было утверждено, 
то в фоновом режиме я занимался FPGA разработкой для проекта, который имеет внутренее название 
"sinya korobochka" (синяя коробочка :) ).

<h3>Синяя коробочка</h3>

<img src="https://habrastorage.org/files/02b/a25/a7d/02ba25a7dc1347bc80cae4fb69368166.jpg" width=450 height=398/>
<br>
Синяя коробочка это такая штука, которую мы будем позиционировать 
как кит для разработки. К сожалению, на сайте еще об этом информации нет, 
но буклетик можно найти <a href="http://metrotek.spb.ru/files/doc/all/pcb-booklet.pdf">тут</a>.

<h4>SoM</h4>

<img src="https://habrastorage.org/files/ed3/7d8/68d/ed37d868dfa84299897c4531c908c281.jpg" width=500 height=285/>
<br>
В его основе лежит SoM (System on Module), где расположен чип Cyclone V SoC от Altera.
Мы этим модули используем в своих приборах (ETN и ETNS), которые идут большими (большое, это конечно относительно число, но мы считаем, что большими :) ) 
партиями.

<h4>КитЪ для разработки</h4>
В итоге мы предлагаем (будем, когда информация об этом на сайте появится) людям использовать
наши SoM'ы в своих проектах. Бонус заключается в том, что если им не надо будет разводить
сложную часть платы, где стоит SoC чип и DDR3 память, а надо будет только сделать свою часть, например, со своими датчиками.
А эта плата может быть очень простой (например, двух- или четырёхслойной).

Для того, чтобы человек мог как-то поиграться с SoM, пока он думает, надо ему это или нет мы сделали плату, на которой
разместили небольшую периферию: Ethernet, USB, консоль, RTC и пр. 

<br><br>

С помощью пинов, которые выведены на стандартные разъемы, к FPGA и HPS можно подключить различные датчики, видеокамеры и пр. 
Похожей философией пользуются и признанные лидеры китов, типа <a href="http://www.terasic.com.tw/en/">Терасика</a>.

<h4>Arduino Shield</h4>

Чисто с синей коробочкой не так всё просто получается, т.к. всё равно
не всё так наглядно может быть для пользователя. 

Поэтому мы решили сделать еще к нему шилд под названием <b>Arduino Shield for CB-CV-SOM</b>.

<br><br>

Он вставляется сверху на синюю коробочку (в разъемы). Выглядит это примерно вот так:

<img src="https://habrastorage.org/files/8a1/a38/95e/8a1a3895ece84bd48c4b014574b806ba.jpg" width=500 height=300/>

<br><br>
Что в нем есть:<br>
<img src="https://habrastorage.org/files/959/7c5/c72/9597c5c72d86420b89a559e5eb6294f1.png" width=500 height=787/>
<br><br>
Тем самым можно получить полноценный компьютер: через USB можно подключить клавиатуру и мышку, а монитор к VGA.

<h3>BSP for Sinya Korobochka</h3>
Правильным путем является еще прикладыванием "CD", куда входят какие-то готовые (желательно рабочие) примеры, например, 
моргания светодиода или еще чего-то такого. Этим я и занимался до Нового Года в фоновом режиме.

<br> <br>
Здесь у нас более серьёзная периферия, чем просто светодиодики. Мы захотели, чтобы
вся периферия была "видна" в линуксе: можно было бы на процессоре запустить какое-то гуёвое приложение и выводилась бы картинка на экран.

В принципе, многие вещи у нас заработали из коробки, но повозиться пришлось. 
<br><br>
Кратко и без подробных технических деталей:

<h4>VGA</h4>
У нас сделано RGB565, а АЦП на резисторах. Т.е. с FPGA уходят сигналы цвета и еще синхронизация (v_sync, h_sync). <br><br>

Сделано всё через стандартный линуксовый фреймбуфер.
Были взяты модули <b>Frame Reader</b> и <b>Clocked Output</b> из <a href="https://www.altera.com/en_US/pdfs/literature/ug/ug_vip.pdf">Altera VIP</a>, а драйвер из исходников
ядра, которое "поддерживает" Альтера (<a href="https://github.com/altera-opensource/linux-socfpga/blob/socfpga-3.18/drivers/video/altvipfb.c">altvipfb.c</a>)
<br><br>
Получилось как-то так:
<br><br>

<img src="https://habrastorage.org/files/c43/3c4/e54/c433c4e5485d4e80b0baf651c247645d.jpg" width=500 height=375/>
<br>
<i>Выводим котика через утилиту "fbi".</i>
<br><br>

<img src="https://habrastorage.org/files/684/bb8/eb6/684bb8eb61ef43a5b382ae9ccefa4b37.jpg" width=500 height=375/>
<br>
<i>Запуск иксов (icewm).</i>

<h4>Audio</h4>
Там используется стандартный чип-кодек <a href="http://www.farnell.com/datasheets/1808088.pdf">SSM2603</a>: один интерфейс
для управления (I2C), второй для получения/отправки аудиоданных (I2S). Эти сигналы тоже заходят на FPGA.
<br><br>

I2C модуль, который настраивает этот кодек на дефолтные настройки мы нашли где-то в интернете и пока захадркодили, а
вот с I2S пришлось немного повозиться: у Альтеры есть <a href="ftp://ftp.altera.com/up/pub/University_Program_IP_Cores/Audio.pdf">IP-ядро</a>, 
которое идеально подходит по то, что нам надо, но оно распроняется по Altera University Program, и типа только для DE1/DE2 борд, а у нас плата-то своя.
<br><br>
Мы конечно, написали запрос в Альтеру, но нам не ответили до сих пор. Пока писали письмо, решили что лучше самим написать I2S контроллер на FPGA,
что мы и сделали (относительно просто получилось). 
<br><br>
В итоге получилось с процессора писать отсчеты, и у нас получилось вывести звук, но пока поддержки со стороны "драйвера" нет - мы писали
из юзерспейсного приложения. 

<h4>ADC (АЦП)</h4>
Там стоит очень простой 1Msps 12-битный чип (<a href="http://www.ti.com/lit/ds/symlink/adc128s102.pdf">ADC128S102</a>), данные читаются по SPI, поэтому
было решено использовать готовое ядро от Альтеры <a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/ug/ug_embedded_ip.pdf">SPI Core</a>.
В качестве SPI-драйвера использовался альтеровский <a href="https://github.com/altera-opensource/linux-socfpga/blob/socfpga-3.18/drivers/spi/spi-altera.c">spi-altera.c</a>.
А в качестве самого АЦП - <a href="https://github.com/altera-opensource/linux-socfpga/blob/socfpga-3.18/drivers/iio/adc/ti-adc128s052.c">ADC128S052</a>. В принципе чипы почти одинаковые)

<br><br>
В итоге появились файлики, из которых читаются "сырые" значения для ADC: <br>
<code>
root@device:~# ls -l /sys/bus/iio/devices/iio\:device0/in_voltage*                          <br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage0_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage1_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage2_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage3_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage4_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage5_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage6_raw<br>
-rw-r--r-- 1 root root 4096 Nov 30 09:34 /sys/bus/iio/devices/iio:device0/in_voltage7_raw<br>
</code>

<h4>DAC (ЦАП)</h4>
Здесь используется 16-битый ЦАП <a href="http://www.ti.com/lit/ds/slas449d/slas449d.pdf">DAC8831</a>. <br>
Он тоже SPI-ный и подключен к FPGA. Поэтому тоже использовали SPI ядро и драйвер от Альтеры. <br><br>

К качестве "высокоуровнего" драйвера было решено взять для <a href="https://github.com/altera-opensource/linux-socfpga/blob/socfpga-3.18/drivers/misc/ti_dac7512.c">DAC7512</a>, 
потому что он тоже был для 16-битного SPI ЦАПа и был самый простой, что мы заметили. 
<br><br>

Появился файл:<br>
<code>
/sys/devices/soc/c0000000.bridge/c0000020.spi/spi_master/spi32765/spi32765.0/value <br>
</code>
<br>
Куда можно записать значение в десятичной форме через echo: <br>
<code>
echo "123" > value <br>
</code>

<br>
Более подробно можно будет всё понять из исходников.
Правда, их я пока не могу выложить, т.к. они не готовы. Как только они появятся на гитхабе, то сделаю здесь ссылку.

<h3>Стоит ли игра свеч?</h3>
Вполне очевидный вопрос задается о целесообразности того, что мы делаем, потому что Терасик предлагает очень вкусные цены на свои киты,
а зная ту цену, которую мы будем сообщать на SoM'ы и синюю коробочку, то может сложиться впечатление, что интереса не будет. <br><br>

Есть мнение, что у Терасика относительно дешешевые цены, т.к. вендоры (Альтера, TI и пр.) могут отдавать Терасику чипы ниже себестоимости 
(и это вполне нормально, т.к. это взаимовыгодно). Таких цен нам Альтера не дает :). <br><br>

Стоит ли переплачивать за "относительно" похожие киты в N раз? <br>
Я вижу следующие факторы: импортозамещение (платы разработаны в России, руками людей, которые сидят через стену от меня), 
реальная техподдержка на русском языке (от меня и моих коллег) и кастомизация под возможные решения заказчика.
<br> <br>

Заинтересует ли это кого-то? Посмотрим :)
      </div> <!-- content -->
  </div> <!-- page -->

  <!-- Yandex.Metrika counter --> <script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter34546245 = new Ya.Metrika({ id:34546245, clickmap:true, trackLinks:true, accurateTrackBounce:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div><img src="https://mc.yandex.ru/watch/34546245" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->

  </body>

</html>
